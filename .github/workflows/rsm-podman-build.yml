name: Build rsm-podman

on:
  push:
    branches: [main]
    paths:
      - 'rsm-podman/**'
      - 'files/**'
      - 'scripts-podman-mp/**'
      - '.github/workflows/rsm-podman-build.yml'
  pull_request:
    branches: [main]
    paths:
      - 'rsm-podman/**'
      - 'files/**'
  workflow_dispatch:
    inputs:
      version:
        description: 'Image version tag'
        required: false
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: radiant-ai-hub/rsm-podman

jobs:
  build-amd64:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Log in to GHCR with Podman
        if: github.event_name != 'pull_request'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build amd64 image with Podman
        run: |
          podman build \
            --platform linux/amd64 \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-amd64 \
            --build-arg IMAGE_VERSION=${{ github.sha }} \
            --format docker \
            -f rsm-podman/Containerfile \
            .

      - name: Push amd64 image
        if: github.event_name != 'pull_request'
        run: |
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-amd64

  build-arm64:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Free up disk space
        run: |
          echo "Before cleanup:"
          df -h
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo docker image prune --all --force
          echo "After cleanup:"
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU for arm64 emulation
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static

      - name: Install Podman
        run: |
          sudo apt-get install -y podman

      - name: Log in to GHCR with Podman
        if: github.event_name != 'pull_request'
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Build arm64 image with Podman
        run: |
          podman build \
            --platform linux/arm64 \
            --tag ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-arm64 \
            --build-arg IMAGE_VERSION=${{ github.sha }} \
            --format docker \
            -f rsm-podman/Containerfile \
            .

      - name: Push arm64 image
        if: github.event_name != 'pull_request'
        run: |
          podman push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-arm64

  create-manifest:
    needs: [build-amd64, build-arm64]
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Install Podman
        run: |
          sudo apt-get update
          sudo apt-get install -y podman

      - name: Log in to GHCR with Podman
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Create and push multi-arch manifest
        run: |
          # Create manifest for the SHA tag
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-arm64
          podman manifest push --all ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

          # Create manifest for latest tag
          podman manifest create ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-amd64
          podman manifest add ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}-arm64
          podman manifest push --all ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            docker://${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest

  integration-tests:
    needs: create-manifest
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        platform: [linux/amd64, linux/arm64]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static

      - name: Install Podman
        run: |
          sudo apt-get install -y podman

      - name: Log in to GHCR with Podman
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | podman login ${{ env.REGISTRY }} -u ${{ github.actor }} --password-stdin

      - name: Pull image for platform
        run: |
          podman pull --platform ${{ matrix.platform }} ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Start container
        run: |
          podman run -d --name rsm-test \
            --platform ${{ matrix.platform }} \
            -p 8765:8765 \
            -p 2222:2222 \
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            /usr/local/bin/start-container.sh

      - name: Wait for container to be healthy
        run: |
          echo "Waiting for container to start..."
          sleep 30

          # Check container is running
          if ! podman ps | grep -q rsm-test; then
            echo "Container failed to start"
            podman logs rsm-test
            exit 1
          fi

          # Wait for PostgreSQL to be ready
          for i in {1..30}; do
            if podman exec rsm-test pg_isready -h localhost -p 8765 -U jovyan 2>/dev/null; then
              echo "PostgreSQL is ready"
              break
            fi
            echo "Waiting for PostgreSQL... ($i/30)"
            sleep 2
          done

      - name: Test PostgreSQL connection
        run: |
          podman exec rsm-test psql -h localhost -p 8765 -U jovyan -c 'SELECT 1 as test;'

      - name: Test PostgreSQL create table
        run: |
          podman exec rsm-test psql -h localhost -p 8765 -U jovyan -c '
            CREATE TABLE test_table (id SERIAL PRIMARY KEY, name TEXT);
            INSERT INTO test_table (name) VALUES ('"'"'test_value'"'"');
            SELECT * FROM test_table;
            DROP TABLE test_table;
          '

      - name: Test Java installation
        run: |
          podman exec rsm-test bash -l -c 'java -version'

      - name: Test environment variables
        run: |
          podman exec rsm-test bash -l -c '
            echo "JAVA_HOME=$JAVA_HOME"
            echo "SPARK_HOME=$SPARK_HOME"
            echo "HADOOP_HOME=$HADOOP_HOME"
            test -n "$JAVA_HOME" || exit 1
            test -n "$SPARK_HOME" || exit 1
            test -n "$HADOOP_HOME" || exit 1
          '

      - name: Test pgweb binary
        run: |
          podman exec rsm-test /usr/local/bin/pgweb_binary --version

      - name: Test SSH configuration
        run: |
          podman exec rsm-test sshd -T | grep -E "port|permitrootlogin"

      - name: Test Python and PySpark imports
        run: |
          podman exec rsm-test bash -l -c '
            python -c "import pyspark; print(f\"PySpark version: {pyspark.__version__}\")"
          '

      - name: Test SSH accepts connections
        run: |
          # Generate a test key
          ssh-keygen -t ed25519 -f /tmp/test_key -N ""
          # Add public key to container
          podman exec rsm-test bash -c "mkdir -p ~/.ssh && chmod 700 ~/.ssh"
          podman cp /tmp/test_key.pub rsm-test:/home/jovyan/.ssh/authorized_keys
          podman exec rsm-test bash -c "chmod 600 ~/.ssh/authorized_keys"
          # Test SSH connection
          ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null \
            -i /tmp/test_key -p 2222 jovyan@localhost echo "SSH connection successful"

      - name: Test Hadoop HDFS initialization
        run: |
          podman exec rsm-test bash -l -c '
            # Initialize HDFS (namenode format)
            cd $HADOOP_HOME
            ./init-dfs.sh
            echo "HDFS initialized successfully"
          '

      - name: Test Hadoop commands
        run: |
          podman exec rsm-test bash -l -c '
            # Verify hadoop command works
            hadoop version
            echo "Hadoop commands working"
          '

      - name: Test PySpark job execution
        run: |
          podman exec rsm-test bash -l -c "python -c 'from pyspark.sql import SparkSession; spark = SparkSession.builder.master(\"local\").getOrCreate(); print(\"PySpark works\"); spark.stop()'"

      - name: Cleanup
        if: always()
        run: |
          podman stop rsm-test || true
          podman rm rsm-test || true
